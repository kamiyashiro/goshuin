<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>御朱印ジェネレーター</title>
<style>
  @font-face {
    font-family: 'KouzanBrush';
    src: url('./KouzanBrushFont.woff2') format('woff2');
  }

  body {
    font-family: 'KouzanBrush', serif;
    text-align: center;
    margin-top: 30px;
  }

  canvas {
    border: 2px solid #333;
  }

  button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>御朱印ジェネレーター</h1>

<canvas id="goshuinCanvas"></canvas><br>

<button id="generateBtn">御朱印生成</button>
<button id="downloadBtn">ダウンロード（WebP）</button>

<script>
const backgroundUrl = "Iwakura.webp";
const canvas = document.getElementById("goshuinCanvas");
const ctx = canvas.getContext("2d");

// 和暦（令和のみ）
function getJapaneseDate(date) {
  const era = "令和";
  const year = date.getFullYear() - 2018;
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const k = ["〇","一","二","三","四","五","六","七","八","九"];

  const y = [...String(year)].map(d=>k[d]).join("");
  const m = month <= 10 ? k[month] : "十" + (month-10 ? k[month-10] : "");
  const d =
    day <= 10 ? k[day] :
    day < 20 ? "十" + (day-10 ? k[day-10] : "") :
    day < 30 ? "二十" + (day-20 ? k[day-20] : "") :
    "三十";

  return `${era}${y}年${m}月${d}日`;
}

// 縦書き
function drawVertical(text, x, y, size) {
  const lh = size * 1.2;
  for (let i = 0; i < text.length; i++) {
    ctx.fillText(text[i], x, y + i * lh);
  }
}

// 背景＋生成前表示
function drawPreview() {
  const img = new Image();
  img.src = backgroundUrl;
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    ctx.font = Math.floor(canvas.width / 18) + "px 'KouzanBrush'";
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    ctx.fillText("ここ御朱印が表示されます", canvas.width / 2, canvas.height / 2);
  };
}

// 御朱印生成
function generateGoshuin() {
  const img = new Image();
  img.src = backgroundUrl;
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    const dateStr = getJapaneseDate(new Date());
    const fontSize = Math.floor(canvas.width / 16 * 1.5);

    ctx.font = fontSize + "px 'KouzanBrush'";
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";

    // 左下詰め
    const x = fontSize * 1.1;
    const totalH = fontSize * 1.2 * dateStr.length;
    const y = canvas.height - totalH - fontSize * 0.6;

    drawVertical(dateStr, x, y, fontSize);
  };
}

// ダウンロード
function downloadGoshuin() {
  const a = document.createElement("a");
  a.download = "KamiyashiroGoshuin.webp";
  a.href = canvas.toDataURL("image/webp");
  a.click();
}

document.getElementById("generateBtn").onclick = generateGoshuin;
document.getElementById("downloadBtn").onclick = downloadGoshuin;

// 初期表示
drawPreview();
</script>

</body>
</html>
