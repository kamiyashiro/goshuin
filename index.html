<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>御朱印ジェネレーター</title>

<style>
@font-face {
  font-family: 'KouzanBrush';
  src: url('./KouzanBrushFont.woff2') format('woff2');
}

body {
  margin: 0;
  padding: 20px;
  background: url('./Iwakura.webp') no-repeat center center fixed;
  background-size: cover;
  text-align: center;
}

#wrap {
  display: inline-block;
  position: relative;
}

/* ボタンエリア：必ず見える */
.controls {
  position: absolute;
  top: 8px;
  left: 8px;
  display: flex;
  gap: 8px;
  z-index: 10;
}

button {
  padding: 6px 14px;
  font-size: 14px;
  cursor: pointer;
  background: #f5f5f5;     /* ← 不透明 */
  border: 1px solid #333;
}

/* キャンバス */
canvas {
  display: block;
  max-width: 90vw;
  height: auto;
}
</style>
</head>

<body>

<div id="wrap">
  <div class="controls">
    <button id="generateBtn">生成</button>
    <button id="downloadBtn">保存</button>
  </div>

  <canvas id="goshuinCanvas"></canvas>
</div>

<script>
const templateUrl = "KamiyashiroGoshuin.webp";
const canvas = document.getElementById("goshuinCanvas");
const ctx = canvas.getContext("2d");

const generateBtn = document.getElementById("generateBtn");
const downloadBtn = document.getElementById("downloadBtn");

/* 初期表示（必ず読める） */
canvas.width = 420;
canvas.height = 180;

// 初期表示だけ白背景
ctx.fillStyle = "#ffffff";
ctx.fillRect(0, 0, canvas.width, canvas.height);

// 枠
ctx.strokeStyle = "#333";
ctx.strokeRect(0, 0, canvas.width, canvas.height);

// 文字
ctx.font = "20px 'KouzanBrush'";
ctx.fillStyle = "#000";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillText("御朱印は此処に授与（表示）されます", canvas.width/2, canvas.height/2);

/* 以下、生成処理（前回と同じ） */

function getJapaneseDate(date) {
  const kan = ["〇","一","二","三","四","五","六","七","八","九"];
  const y = date.getFullYear() - 2018;
  const m = date.getMonth() + 1;
  const d = date.getDate();
  return `令和${String(y).split("").map(n=>kan[n]).join("")}年` +
         `${m<=10?kan[m]:"十"+kan[m-10]}月` +
         `${d<=10?kan[d]:d<20?"十"+kan[d-10]:d<30?"二十"+kan[d-20]:"三十"}日`;
}

function drawVertical(text, x, y, lh) {
  for (let i=0;i<text.length;i++) ctx.fillText(text[i], x, y + i*lh);
}

function generateGoshuin() {
  const img = new Image();
  img.src = templateUrl;
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);

    const dateStr = getJapaneseDate(new Date());
    const size = Math.floor((canvas.width/16)*1.5);

    ctx.font = `bold ${size}px 'KouzanBrush'`;
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    ctx.textBaseline = "top";

    const lh = size * 1.15;
    const x = size * 1.2;
    const y = canvas.height - lh * dateStr.length - size * 0.5;

    drawVertical(dateStr, x, y, lh);
  };
}

function downloadGoshuin() {
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/webp");
  a.download = "KamiyashiroGoshuin.webp";
  a.click();
}

generateBtn.onclick = generateGoshuin;
downloadBtn.onclick = downloadGoshuin;
</script>

</body>
</html>
