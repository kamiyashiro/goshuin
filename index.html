<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>御朱印ジェネレーター（KouzanBrushFont）</title>
<style>
  /* アップロード済みフォントを読み込む */
  @font-face {
    font-family: 'KouzanBrush';
    src: url('./KouzanBrushFont.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
  }

  body {
    font-family: 'KouzanBrush', serif;
    text-align: center;
    margin-top: 50px;
  }
  canvas {
    border: 2px solid #333;
  }
  button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>御朱印ジェネレーター（KouzanBrush）</h1>
<canvas id="goshuinCanvas"></canvas><br>
<button id="generateBtn">御朱印生成</button>
<button id="downloadBtn">ダウンロード（WebP）</button>

<script>
const templateUrl = "KamiyashiroGoshuin.webp";
const canvas = document.getElementById("goshuinCanvas");
const ctx = canvas.getContext("2d");
const generateBtn = document.getElementById("generateBtn");
const downloadBtn = document.getElementById("downloadBtn");

// 和暦変換（令和のみ対応）
function getJapaneseDate(date) {
  const era = "令和";
  const year = date.getFullYear() - 2018;
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const kanji = ["〇","一","二","三","四","五","六","七","八","九"];

  const yearStr = Array.from(String(year)).map(d => kanji[+d]).join("");
  const monthStr = (month<=10?kanji[month]: "十" + (month-10>0?kanji[month-10]:"")) + "月";
  const dayStr = (day<=10?kanji[day]: day<20? "十" + (day-10>0?kanji[day-10]:""): day<30? "二十" + (day-20>0?kanji[day-20]:""):"三十") + "日";

  return `${era}${yearStr}年${monthStr}${dayStr}`;
}

// 縦書き描画（左中央・強調）
function drawVerticalText(ctx, text, x, y, lineHeight) {
  for(let i=0; i<text.length; i++){
    // 影で立体感
    ctx.fillStyle = "rgba(0,0,0,0.2)";
    ctx.fillText(text[i], x + 1, y + i * lineHeight + 1);

    // メイン色
    ctx.fillStyle = "#cc0000";
    ctx.fillText(text[i], x, y + i * lineHeight);
  }
}

function generateGoshuin() {
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = templateUrl;
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    const now = new Date();
    const dateStr = getJapaneseDate(now);

    const fontSize = Math.floor(canvas.width / 16); // 少し大きめ
    ctx.font = fontSize + "px 'KouzanBrush', serif";
    ctx.textAlign = "center";

    const lineHeight = fontSize * 1.2;
    const x = fontSize * 1.2; // 左側に少し内側
    const y = (canvas.height - lineHeight * dateStr.length) / 2;

    drawVerticalText(ctx, dateStr, x, y, lineHeight);
  };
}

function downloadGoshuin() {
  const link = document.createElement("a");
  link.download = "KamiyashiroGoshuin.webp";
  link.href = canvas.toDataURL("image/webp");
  link.click();
}

generateBtn.addEventListener("click", generateGoshuin);
downloadBtn.addEventListener("click", downloadGoshuin);
</script>

</body>
</html>
