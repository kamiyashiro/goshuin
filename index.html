<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>御朱印ジェネレーター</title>

<style>
@font-face {
  font-family: 'KouzanBrush';
  src: url('./KouzanBrushFont.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  background: url("Iwakura.webp") no-repeat center center fixed;
  background-size: cover;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* 全体枠 */
#container {
  position: relative;
}

/* 初期は最小 */
canvas {
  border: 2px solid #333;
  background: #fff;
}

/* ボタンはキャンバス上 */
#controls {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 6px;
}

button {
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="container">
  <canvas id="goshuinCanvas" width="320" height="120"></canvas>

  <div id="controls">
    <button id="generateBtn">生成</button>
    <button id="downloadBtn">保存</button>
  </div>
</div>

<script>
const canvas = document.getElementById("goshuinCanvas");
const ctx = canvas.getContext("2d");
const generateBtn = document.getElementById("generateBtn");
const downloadBtn = document.getElementById("downloadBtn");

const goshuinImage = "KamiyashiroGoshuin.webp";

/* 和暦（令和） */
function getJapaneseDate() {
  const d = new Date();
  const y = d.getFullYear() - 2018;
  const m = d.getMonth() + 1;
  const day = d.getDate();
  return `令和${y}年${m}月${day}日`;
}

/* 縦書き描画 */
function drawVertical(text, x, y, size) {
  ctx.font = `${size}px 'KouzanBrush'`;
  ctx.fillStyle = "#000";
  ctx.textAlign = "center";
  for (let i = 0; i < text.length; i++) {
    ctx.fillText(text[i], x, y + i * size * 1.1);
  }
}

/* 初期表示（文字のみ・最小） */
function init() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.font = "16px 'KouzanBrush'";
  ctx.fillStyle = "#000";
  ctx.textAlign = "center";
  ctx.fillText("御朱印は此処に授与（表示）されます", canvas.width/2, canvas.height/2);
}

init();

/* 生成 */
generateBtn.onclick = () => {
  const img = new Image();
  img.src = goshuinImage;
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);

    const date = getJapaneseDate();
    const size = canvas.width / 14;

    drawVertical(
      date,
      canvas.width * 0.12,
      canvas.height * 0.25,
      size
    );
  };
};

/* 保存 */
downloadBtn.onclick = () => {
  const a = document.createElement("a");
  a.download = "goshuin.webp";
  a.href = canvas.toDataURL("image/webp");
  a.click();
};
</script>

</body>
</html>
