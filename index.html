<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>御朱印授与所　Goshuin Granting Office</title>
<style>
@font-face {
  font-family: 'KouzanBrush';
  src: url('./KouzanBrushFont.woff2') format('woff2');
}

body {
  margin: 0;
  padding: 40px 20px 20px;
  background: url('./Iwakura.webp') no-repeat center center fixed;
  background-size: cover;
  text-align: center;
  font-family: sans-serif;
}

/* ページ上部の大きなタイトル（朱色＋白縁取り） */
.header-title {
  font-size: 48px;
  font-weight: bold;
  color: #d40000; /* 朱色 */
  -webkit-text-stroke: 3px white; /* 白縁取り（Chrome/Safari） */
  text-stroke: 3px white; /* 標準（一部ブラウザ） */
  text-shadow: 
    3px 3px 0 white, -3px -3px 0 white,
    3px -3px 0 white, -3px 3px 0 white,
    0 3px 0 white, 0 -3px 0 white,
    3px 0 0 white, -3px 0 0 white;
  margin-bottom: 30px;
  letter-spacing: 4px;
}

/* 英語部分は縁取りなし・別フォント */
.header-title-en {
  display: block;
  font-size: 32px;
  color: #d40000;
  font-family: 'Georgia', 'Times New Roman', serif;
  margin-top: 10px;
  -webkit-text-stroke: 0;
  text-stroke: 0;
  text-shadow: none;
}

#wrap {
  display: inline-block;
  position: relative;
}

/* ボタンエリア：常に最前面で操作可能 */
.controls {
  position: absolute;
  top: 8px;
  left: 8px;
  display: flex;
  gap: 12px;
  z-index: 100; /* 十分高い値で最前面に */
}

button {
  padding: 10px 18px;
  font-size: 16px;
  cursor: pointer;
  background: rgba(245, 245, 245, 0.95);
  border: 2px solid #333;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-weight: bold;
}

button:hover {
  background: #ffffff;
}

/* キャンバス */
canvas {
  display: block;
  max-width: 90vw;
  height: auto;
  border: 2px solid #333;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  background: white; /* 読み込み前も見やすいように */
}
</style>
</head>
<body>

<!-- ページ上部の大きなタイトル -->
<div class="header-title">
  御朱印授与所
  <span class="header-title-en">Goshuin Granting Office</span>
</div>

<div id="wrap">
  <!-- ボタンエリア（最前面） -->
  <div class="controls">
    <button id="generateBtn">生成<br><span style="font-size:12px;">Generate</span></button>
    <button id="downloadBtn">保存<br><span style="font-size:12px;">Download</span></button>
  </div>

  <!-- キャンバス -->
  <canvas id="goshuinCanvas"></canvas>
</div>

<script>
const templateUrl = "KamiyashiroGoshuin.webp";
const canvas = document.getElementById("goshuinCanvas");
const ctx = canvas.getContext("2d");
const generateBtn = document.getElementById("generateBtn");
const downloadBtn = document.getElementById("downloadBtn");

/* 初期表示（読みやすく和英併記） */
canvas.width = 420;
canvas.height = 300; // 高さを少し増やして文字が収まるように
ctx.fillStyle = "#ffffff";
ctx.fillRect(0, 0, canvas.width, canvas.height);

// 外枠
ctx.strokeStyle = "#333";
ctx.lineWidth = 3;
ctx.strokeRect(0, 0, canvas.width, canvas.height);

// 和文（筆文字フォント）
ctx.font = "30px 'KouzanBrush'";
ctx.fillStyle = "#000";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillText("御朱印は此処に授与（表示）されます", canvas.width/2, canvas.height/2 - 20);

// 英文（標準フォント）
ctx.font = "20px sans-serif";
ctx.fillStyle = "#444";
ctx.fillText("Goshuin will be displayed here", canvas.width/2, canvas.height/2 + 20);

/* 日付を和風に変換 */
function getJapaneseDate(date) {
  const kan = ["〇","一","二","三","四","五","六","七","八","九"];
  const y = date.getFullYear() - 2018; // 令和元年 = 2019
  const m = date.getMonth() + 1;
  const d = date.getDate();

  let yearStr = "令和";
  if (y === 1) yearStr += "元";
  else yearStr += String(y).split("").map(n => kan[n]).join("");

  yearStr += "年";

  let monthStr = m <= 10 ? kan[m] : "十" + (m-10 === 0 ? "" : kan[m-10]);
  monthStr += "月";

  let dayStr;
  if (d <= 10) dayStr = kan[d];
  else if (d < 20) dayStr = "十" + (d-10 === 0 ? "" : kan[d-10]);
  else if (d < 30) dayStr = "二十" + kan[d-20];
  else dayStr = "三十" + kan[d-30];

  dayStr += "日";

  return yearStr + monthStr + dayStr;
}

function drawVertical(text, x, y, lh) {
  for (let i = 0; i < text.length; i++) {
    ctx.fillText(text[i], x, y + i * lh);
  }
}

function generateGoshuin() {
  const img = new Image();
  img.crossOrigin = "anonymous"; // 必要に応じて
  img.src = templateUrl;
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    const dateStr = getJapaneseDate(new Date());
    const size = Math.floor((canvas.width / 16) * 1.5);
    ctx.font = `bold ${size}px 'KouzanBrush'`;
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    ctx.textBaseline = "top";

    const lh = size * 1.15;
    const x = size * 1.2;
    const y = canvas.height - lh * dateStr.length - size * 0.5;

    drawVertical(dateStr, x, y, lh);
  };
}

function downloadGoshuin() {
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/webp");
  a.download = "KamiyashiroGoshuin.webp";
  a.click();
}

generateBtn.onclick = generateGoshuin;
downloadBtn.onclick = downloadGoshuin;
</script>
</body>
</html>
