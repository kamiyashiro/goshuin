<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SL用御朱印生成 for Second Life</title>

<!-- GitHub Pagesキャッシュ回避用（強く推奨） -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
@font-face {
 font-family: 'KouzanBrush';
 src: url('./KouzanBrushFont.woff2') format('woff2');
}

body {
 margin: 0;
 padding: 20px;
 background: url('./Iwakura.webp') no-repeat center center fixed;
 background-size: cover;
 font-family: sans-serif;
 text-align: center;
}

.header-title-ja {
 font-size: 32px;
 color: #d40000;
 margin-bottom: 10px;
 font-family: 'KouzanBrush', sans-serif;
}

.header-title-en {
 display: block;
 font-size: 20px;
 color: #d40000;
 margin-bottom: 10px;
 font-family: 'MS Gothic', 'ＭＳ ゴシック', sans-serif;
}

#wrap {
 display: inline-block;
 position: relative;
 margin-top: 20px;
}

.controls {
 margin-bottom: 10px;
 display: flex;
 flex-wrap: wrap;
 justify-content: center;
 gap: 10px;
 align-items: center;
}

.controls-row {
 display: flex;
 flex-wrap: wrap;
 justify-content: center;
 gap: 10px;
 margin-bottom: 5px;
}

select, button, input[type="range"], input[type="checkbox"], input[type="file"] {
 padding: 6px 12px;
 font-size: 14px;
 cursor: pointer;
 border-radius: 6px;
 border: 2px solid #333;
 font-weight: bold;
}

canvas {
 border: 2px solid #333;
 box-shadow: 0 4px 12px rgba(0,0,0,0.4);
 background: white;
}

/* バージョン表示用スタイル */
#version {
 margin-top: 30px;
 font-size: 12px;
 color: #666;
 font-family: 'MS Gothic', sans-serif;
}
</style>
</head>
<body>

<div>
 <div class="header-title-ja">SL用御朱印生成</div>
 <div class="header-title-en">Goshuin Generator for Second Life</div>
</div>

<div id="wrap">
 <!-- 1行目：基本操作 -->
 <div class="controls controls-row">
  年: <select id="yearSelect"></select>
  前月: <button id="prevMonthBtn">◀</button>
  次月: <button id="nextMonthBtn">▶</button>
  X位置: <input type="range" id="posXSlider" min="0" max="512" value="50"><span id="posXLabel">50px</span>
  Y位置: <input type="range" id="posYSlider" min="0" max="512" value="50"><span id="posYLabel">50px</span>
  保存: <button id="downloadBtn">保存</button>
  一括ZIP: <button id="downloadAllBtn">全て保存</button>
 </div>

 <!-- 2行目：文字効果調整 -->
 <div class="controls controls-row">
  文字サイズ: <input type="range" id="fontSizeSlider" min="8" max="80" value="38"><span id="fontSizeLabel">38px</span>
  補正: <input type="range" id="textCorrectionSlider" min="-5" max="5" value="0"><span id="textCorrectionLabel">0px</span>
  中塗り濃さ: <input type="range" id="fillOpacitySlider" min="10" max="100" value="100"><span id="fillOpacityLabel">100%</span>
  重ね回数: <input type="range" id="fillRepeatSlider" min="1" max="5" value="4"><span id="fillRepeatLabel">4</span>
  アンチエイリアス: <input type="checkbox" id="aaSwitch" checked>
  外周線: <input type="checkbox" id="strokeSwitch">
  外周太さ: <input type="range" id="strokeWidthSlider" min="1" max="10" value="1"><span id="strokeWidthLabel">1</span>
 </div>

 <!-- 3行目：設定保存/読み込み -->
 <div class="controls controls-row">
  <button id="exportSettingsBtn">設定を保存</button>
  <input type="file" id="importSettingsInput" accept=".json">
 </div>

 <canvas id="goshuinCanvas"></canvas>

 <!-- バージョン表示 -->
 <div id="version">Ver. 2025.12.28-2308</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.11.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
const canvas = document.getElementById("goshuinCanvas");
const ctx = canvas.getContext("2d");
const templateUrl = "KamiyashiroGoshuinSL.png";
let currentMonth = 1;
const totalMonths = 12;

// スライダ・チェック要素（省略：変更なし）

const fontSizeSlider = document.getElementById("fontSizeSlider");
const fontSizeLabel = document.getElementById("fontSizeLabel");
const textCorrectionSlider = document.getElementById("textCorrectionSlider");
const textCorrectionLabel = document.getElementById("textCorrectionLabel");
const fillOpacitySlider = document.getElementById("fillOpacitySlider");
const fillOpacityLabel = document.getElementById("fillOpacityLabel");
const fillRepeatSlider = document.getElementById("fillRepeatSlider");
const fillRepeatLabel = document.getElementById("fillRepeatLabel");
const strokeWidthSlider = document.getElementById("strokeWidthSlider");
const strokeWidthLabel = document.getElementById("strokeWidthLabel");
const posXSlider = document.getElementById("posXSlider");
const posYSlider = document.getElementById("posYSlider");
const posXLabel = document.getElementById("posXLabel");
const posYLabel = document.getElementById("posYLabel");
const aaSwitch = document.getElementById("aaSwitch");
const strokeSwitch = document.getElementById("strokeSwitch");

const yearSelect = document.getElementById("yearSelect");
const nowYear = new Date().getFullYear();
for (let y = nowYear - 4; y <= nowYear + 5; y++) {
 const option = document.createElement("option");
 option.value = y;
 option.textContent = y + "年";
 if (y === nowYear) option.selected = true;
 yearSelect.appendChild(option);
}

// 漢数字変換・getJapaneseDate・drawVertical・drawMonth（すべて変更なし、省略）

// （中略：すべての関数は前回と同じ）

// 一括 ZIP（修正版：進捗表示付き）
document.getElementById("downloadAllBtn").onclick = async () => {
  const zip = new JSZip();
  const year = getSelectedYear();
  const btn = document.getElementById("downloadAllBtn");
  const originalText = btn.textContent;

  btn.disabled = true;
  btn.textContent = "生成中...";

  try {
    for (let m = 1; m <= totalMonths; m++) {
      await drawMonth(m, year);
      const dataURL = canvas.toDataURL("image/png");
      const base64 = dataURL.split(",")[1];
      const filename = `KamiyashiroGoshuin${year}${m.toString().padStart(2, "0")}.png`;
      zip.file(filename, base64, { base64: true });

      btn.textContent = `生成中... (${m}/12)`;
    }

    const content = await zip.generateAsync({ type: "blob" });
    saveAs(content, `KamiyashiroGoshuin${year}.zip`);
  } catch (err) {
    console.error(err);
    alert("一括保存中にエラーが発生しました。ブラウザのコンソールを確認してください。");
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
};

// （その他のイベントハンドラはすべて変更なし）

function getSelectedYear(){return parseInt(yearSelect.value,10);}

// 初期表示
drawMonth(currentMonth,getSelectedYear());
</script>
</body>
</html>
