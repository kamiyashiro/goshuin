<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SL用御朱印生成</title>
<style>
@font-face {
  font-family: 'KouzanBrush';
  src: url('./KouzanBrushFont.woff2') format('woff2');
}
body { margin:0; padding:20px; background:#fff; font-family:sans-serif; text-align:center;}
.header-title-ja { font-size:32px; color:#d40000; margin-bottom:10px; font-family:'KouzanBrush',sans-serif;}
.header-title-en { display:block; font-size:20px; color:#d40000; margin-bottom:10px; font-family:'MS Gothic','ＭＳ ゴシック',sans-serif;}
#wrap { display:inline-block; position:relative; margin-top:20px; }
.controls { margin-bottom:10px; display:flex; flex-wrap:wrap; justify-content:center; gap:10px; align-items:center; }
select, button, input[type="range"] { padding:6px 12px; font-size:14px; cursor:pointer; border-radius:6px; border:2px solid #333; font-weight:bold;}
canvas { border:2px solid #333; box-shadow:0 4px 12px rgba(0,0,0,0.4); background:white;}
</style>
</head>
<body>

<div>
  <div class="header-title-ja">SL用御朱印生成</div>
  <div class="header-title-en">Goshuin Generator for Second Life</div>
</div>

<div id="wrap">
  <div class="controls">
    年: <select id="yearSelect"></select>
    月: <select id="monthSelect"></select>
    文字サイズ: <input type="range" id="fontSizeSlider" min="8" max="80" value="38"><span id="fontSizeLabel">38px</span>
    X位置: <input type="range" id="posXSlider" min="0" max="512" value="50"><span id="posXLabel">50px</span>
    Y位置: <input type="range" id="posYSlider" min="0" max="512" value="50"><span id="posYLabel">50px</span>
    <button id="downloadBtn">保存</button>
  </div>
  <canvas id="goshuinCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById("goshuinCanvas");
const ctx = canvas.getContext("2d");
const templateUrl = "KamiyashiroGoshuinSL.png";

const fontSizeSlider = document.getElementById("fontSizeSlider");
const fontSizeLabel = document.getElementById("fontSizeLabel");
const posXSlider = document.getElementById("posXSlider");
const posYSlider = document.getElementById("posYSlider");
const posXLabel = document.getElementById("posXLabel");
const posYLabel = document.getElementById("posYLabel");
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");

const nowYear = new Date().getFullYear();
for(let y=nowYear-4;y<=nowYear+5;y++){
  const option = document.createElement("option");
  option.value=y; option.textContent=y+"年";
  if(y===nowYear) option.selected=true;
  yearSelect.appendChild(option);
}
for(let m=1;m<=12;m++){
  const option = document.createElement("option");
  option.value=m; option.textContent=m+"月";
  if(m===new Date().getMonth()+1) option.selected=true;
  monthSelect.appendChild(option);
}

const kan=["〇","一","二","三","四","五","六","七","八","九"];
function numToKanji(n){
  if(n<=10) return n===10?"十":kan[n];
  if(n<20) return "十"+(n-10===0?"":kan[n-10]);
  if(n<30) return "二十"+(n-20===0?"":kan[n-20]);
  if(n<40) return "三十"+(n-30===0?"":kan[n-30]);
  return n.toString();
}

function getJapaneseYearString(year){
  const y=year-2018;
  if(y===1) return "令和元年吉日";
  else return "令和"+numToKanji(y)+"年吉日";
}

function drawGoshuin(){
  const img=new Image();
  img.crossOrigin="anonymous"; img.src=templateUrl;
  img.onload=()=>{
    canvas.width=img.width; canvas.height=img.height;
    ctx.drawImage(img,0,0);
    const text=getJapaneseYearString(parseInt(yearSelect.value,10));
    const size=parseInt(fontSizeSlider.value,10);
    const x=parseInt(posXSlider.value,10);
    const y=parseInt(posYSlider.value,10);
    ctx.font=`bold ${size}px 'KouzanBrush'`;
    ctx.fillStyle="#000";
    ctx.textAlign="center"; ctx.textBaseline="top";
    const lh=size*1.15;
    for(let i=0;i<text.length;i++) ctx.fillText(text[i],x,y+i*lh);
  };
}

yearSelect.onchange=drawGoshuin; monthSelect.onchange=drawGoshuin;
fontSizeSlider.oninput=()=>{ fontSizeLabel.textContent=fontSizeSlider.value+"px"; drawGoshuin(); };
posXSlider.oninput=()=>{ posXLabel.textContent=posXSlider.value+"px"; drawGoshuin(); };
posYSlider.oninput=()=>{ posYLabel.textContent=posYSlider.value+"px"; drawGoshuin(); };

document.getElementById("downloadBtn").onclick=()=>{
  const mm=monthSelect.value.toString().padStart(2,"0");
  const fileName=`KamiyashiroGoshuin${yearSelect.value}${mm}.png`;
  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png"); a.download=fileName; a.click();
};

drawGoshuin();
</script>

</body>
</html>
