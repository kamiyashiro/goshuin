<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SL用御朱印生成 for Second Life</title>
<style>
@font-face {
  font-family: 'KouzanBrush';
  src: url('./KouzanBrushFont.woff2') format('woff2');
}
body {
  margin: 0; padding: 20px;
  background: url('./Iwakura.webp') no-repeat center center fixed;
  background-size: cover;
  font-family: sans-serif; text-align: center;
}
.header-title-ja { font-size: 32px; color: #d40000; margin-bottom: 10px; font-family: 'KouzanBrush', sans-serif; }
.header-title-en { display: block; font-size: 20px; color: #d40000; margin-bottom: 10px; font-family: 'MS Gothic', 'ＭＳ ゴシック', sans-serif; }
#wrap { display: inline-block; position: relative; margin-top: 20px; }
.controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; align-items: center; }
select, button, input[type="range"] { padding: 6px 12px; font-size: 14px; cursor: pointer; border-radius: 6px; border: 2px solid #333; font-weight: bold; }
canvas { border: 2px solid #333; box-shadow: 0 4px 12px rgba(0,0,0,0.4); background: white; }
</style>
</head>
<body>

<div>
  <div class="header-title-ja">SL用御朱印生成</div>
  <div class="header-title-en">Goshuin Generator for Second Life</div>
</div>

<div id="wrap">
  <div class="controls">
    年: <select id="yearSelect"></select>
    文字サイズ: <input type="range" id="fontSizeSlider" min="8" max="80" value="38">
    <span id="fontSizeLabel">38px</span>
    X位置: <input type="range" id="posXSlider" min="0" max="512" value="50">
    <span id="posXLabel">50px</span>
    Y位置: <input type="range" id="posYSlider" min="0" max="512" value="50">
    <span id="posYLabel">50px</span>
    <button id="prevMonthBtn">前月</button>
    <button id="nextMonthBtn">次月</button>
    <button id="downloadBtn">保存</button>
    <button id="generateAllBtn">一括生成</button>
  </div>
  <canvas id="goshuinCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById("goshuinCanvas");
const ctx = canvas.getContext("2d");
const templateUrl = "KamiyashiroGoshuinSL.png";
let currentMonth = 1;
const totalMonths = 12;

const fontSizeSlider = document.getElementById("fontSizeSlider");
const fontSizeLabel = document.getElementById("fontSizeLabel");
const posXSlider = document.getElementById("posXSlider");
const posYSlider = document.getElementById("posYSlider");
const posXLabel = document.getElementById("posXLabel");
const posYLabel = document.getElementById("posYLabel");
const yearSelect = document.getElementById("yearSelect");
const nowYear = new Date().getFullYear();
for (let y = nowYear-4; y <= nowYear+5; y++) {
  const option = document.createElement("option");
  option.value = y;
  option.textContent = y + "年";
  if (y === nowYear) option.selected = true;
  yearSelect.appendChild(option);
}

yearSelect.onchange = () => drawMonth(currentMonth, getSelectedYear());
fontSizeSlider.oninput = () => { fontSizeLabel.textContent = fontSizeSlider.value + "px"; drawMonth(currentMonth, getSelectedYear()); };
posXSlider.oninput = () => { posXLabel.textContent = posXSlider.value + "px"; drawMonth(currentMonth, getSelectedYear()); };
posYSlider.oninput = () => { posYLabel.textContent = posYSlider.value + "px"; drawMonth(currentMonth, getSelectedYear()); };

function getSelectedYear(){ return parseInt(yearSelect.value,10); }

const kan = ["〇","一","二","三","四","五","六","七","八","九"];

function numToKanji(n){
  if(n <=10) return n===10?"十":kan[n];
  let tens = Math.floor(n/10);
  let ones = n%10;
  let str="";
  if(tens===1) str+="十"; else str+=kan[tens]+"十";
  if(ones>0) str+=kan[ones];
  return str;
}

function getJapaneseDateString(year, month){
  const y = year-2018;
  const yearStr = "令和" + (y===1?"元":String(y).split("").map(n=>kan[n]).join("")) + "年";
  const monthStr = numToKanji(month) + "月";
  return yearStr + monthStr + "吉日";
}

function drawVertical(text, x, y, lh){ for(let i=0;i<text.length;i++) ctx.fillText(text[i], x, y+i*lh); }

function drawMonth(month, year){
  const img = new Image();
  img.crossOrigin="anonymous";
  img.src = templateUrl;
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    const dateStr = getJapaneseDateString(year, month);
    const size = parseInt(fontSizeSlider.value,10);
    const lh = size*1.15;
    const x = parseInt(posXSlider.value,10);
    const y = parseInt(posYSlider.value,10);

    ctx.font = `bold ${size}px 'KouzanBrush'`;
    ctx.fillStyle="#000";
    ctx.textAlign="center";
    ctx.textBaseline="top";
    drawVertical(dateStr,x,y,lh);
  };
}

document.getElementById("prevMonthBtn").onclick = () => { currentMonth = currentMonth>1?currentMonth-1:totalMonths; drawMonth(currentMonth,getSelectedYear()); };
document.getElementById("nextMonthBtn").onclick = () => { currentMonth = currentMonth<totalMonths?currentMonth+1:1; drawMonth(currentMonth,getSelectedYear()); };

document.getElementById("downloadBtn").onclick = () => {
  const mm = currentMonth.toString().padStart(2,"0");
  const fileName = `KamiyashiroGoshuin${getSelectedYear()}${mm}.png`;
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = fileName;
  a.click();
};

document.getElementById("generateAllBtn").onclick = () => {
  for(let month=1;month<=12;month++){
    const img = new Image();
    img.crossOrigin="anonymous";
    img.src = templateUrl;
    img.onload=()=>{
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);

      const dateStr = getJapaneseDateString(getSelectedYear(),month);
      const size = parseInt(fontSizeSlider.value,10);
      const lh = size*1.15;
      const x = parseInt(posXSlider.value,10);
      const y = parseInt(posYSlider.value,10);

      ctx.font = `bold ${size}px 'KouzanBrush'`;
      ctx.fillStyle="#000";
      ctx.textAlign="center";
      ctx.textBaseline="top";
      drawVertical(dateStr,x,y,lh);

      const mm = month.toString().padStart(2,"0");
      const fileName = `KamiyashiroGoshuin${getSelectedYear()}${mm}.png`;
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = fileName;
      a.click();
    };
  }
};

// 初期表示
drawMonth(currentMonth,getSelectedYear());
</script>
</body>
</html>
