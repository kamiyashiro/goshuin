<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SL用御朱印生成 for Second Life</title>
<style>
@font-face {
  font-family: 'KouzanBrush';
  src: url('./KouzanBrushFont.woff2') format('woff2');
}
body {
  margin: 0;
  padding: 20px;
  background: url('./Iwakura.webp') no-repeat center center fixed;
  background-size: cover;
  font-family: sans-serif;
  text-align: center;
}
.header-title-ja {
  font-size: 32px;
  color: #d40000;
  margin-bottom: 10px;
  font-family: 'KouzanBrush', sans-serif;
}
.header-title-en {
  display: block;
  font-size: 20px;
  color: #d40000;
  margin-bottom: 10px;
  font-family: 'MS Gothic', 'ＭＳ ゴシック', sans-serif;
}
#wrap {
  display: inline-block;
  position: relative;
  margin-top: 20px;
}
.controls {
  margin-bottom: 10px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  align-items: center;
}
select, button, input[type="range"] {
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 6px;
  border: 2px solid #333;
  font-weight: bold;
}
canvas {
  border: 2px solid #333;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  background: white;
}
</style>
</head>
<body>
<div>
  <div class="header-title-ja">SL用御朱印生成</div>
  <div class="header-title-en">Goshuin Generator for Second Life</div>
</div>
<div id="wrap">
  <div class="controls">
    年: <select id="yearSelect"></select>
    文字サイズ: <input type="range" id="fontSizeSlider" min="8" max="80" value="38">
    <span id="fontSizeLabel">38px</span>
    X位置: <input type="range" id="posXSlider" min="0" max="512" value="50">
    <span id="posXLabel">50px</span>
    Y位置: <input type="range" id="posYSlider" min="0" max="512" value="50">
    <span id="posYLabel">50px</span>
    <button id="prevMonthBtn">前月</button>
    <button id="nextMonthBtn">次月</button>
    <button id="downloadBtn">保存</button>
    <button id="downloadAllBtn">一括ZIP保存</button>
  </div>
  <canvas id="goshuinCanvas"></canvas>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.11.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
const canvas = document.getElementById("goshuinCanvas");
const ctx = canvas.getContext("2d");
const templateUrl = "KamiyashiroGoshuinSL.png";
let currentMonth = 1;
const totalMonths = 12;
const fontSizeSlider = document.getElementById("fontSizeSlider");
const fontSizeLabel = document.getElementById("fontSizeLabel");
const posXSlider = document.getElementById("posXSlider");
const posYSlider = document.getElementById("posYSlider");
const posXLabel = document.getElementById("posXLabel");
const posYLabel = document.getElementById("posYLabel");
const yearSelect = document.getElementById("yearSelect");
const downloadAllBtn = document.getElementById("downloadAllBtn");
const nowYear = new Date().getFullYear();
for (let y = nowYear - 4; y <= nowYear + 5; y++) {
  const option = document.createElement("option");
  option.value = y;
  option.textContent = y + "年";
  if (y === nowYear) option.selected = true;
  yearSelect.appendChild(option);
}
yearSelect.onchange = () => drawMonth(currentMonth, getSelectedYear());
fontSizeSlider.oninput = () => { fontSizeLabel.textContent = fontSizeSlider.value + "px"; drawMonth(currentMonth, getSelectedYear()); };
posXSlider.oninput = () => { posXLabel.textContent = posXSlider.value + "px"; drawMonth(currentMonth, getSelectedYear()); };
posYSlider.oninput = () => { posYLabel.textContent = posYSlider.value + "px"; drawMonth(currentMonth, getSelectedYear()); };
function getSelectedYear() {
  return parseInt(yearSelect.value, 10);
}
// 漢数字変換
const kan = ["〇","一","二","三","四","五","六","七","八","九"];
function toKanji(n) {
  if (n <= 9) return kan[n];
  if (n === 10) return "十";
  if (n < 20) return "十" + (n % 10 === 0 ? "" : kan[n % 10]);
  if (n < 30) return "二十" + (n % 10 === 0 ? "" : kan[n % 10]);
  if (n < 40) return "三十" + (n % 10 === 0 ? "" : kan[n % 10]);
  return "";
}
function getJapaneseDate(year, month) {
  const y = year - 2018;
  const yearStr = y === 1 ? "令和元年" : "令和" + toKanji(y) + "年";
  const monthStr = toKanji(month) + "月";
  return yearStr + monthStr + "吉日";
}
function drawVertical(text, x, y, lh, ctxRef) {
  for (let i = 0; i < text.length; i++) ctxRef.fillText(text[i], x, y + i * lh);
}
// テンプレート画像をプリロード
let templateImage = null;
const loadTemplate = new Promise((resolve, reject) => {
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = templateUrl;
  img.onload = () => {
    templateImage = img;
    resolve();
  };
  img.onerror = () => reject(new Error("テンプレート画像のロードに失敗しました"));
});
function drawMonth(month, year, ctxRef = ctx) {
  return loadTemplate.then(() => {
    ctxRef.canvas.width = templateImage.width;
    ctxRef.canvas.height = templateImage.height;
    ctxRef.drawImage(templateImage, 0, 0);
    const dateStr = getJapaneseDate(year, month);
    const size = parseInt(fontSizeSlider.value, 10);
    const lh = size * 1.15;
    const x = parseInt(posXSlider.value, 10);
    const y = parseInt(posYSlider.value, 10);
    ctxRef.font = `bold ${size}px 'KouzanBrush'`;
    ctxRef.fillStyle = "#000";
    ctxRef.textAlign = "center";
    ctxRef.textBaseline = "top";
    ctxRef.imageSmoothingEnabled = false;
    drawVertical(dateStr, x, y, lh, ctxRef);
  });
}
// 月切替ボタン
document.getElementById("prevMonthBtn").onclick = () => { currentMonth = currentMonth > 1 ? currentMonth - 1 : totalMonths; drawMonth(currentMonth, getSelectedYear()); };
document.getElementById("nextMonthBtn").onclick = () => { currentMonth = currentMonth < totalMonths ? currentMonth + 1 : 1; drawMonth(currentMonth, getSelectedYear()); };
// 保存
document.getElementById("downloadBtn").onclick = async () => {
  await drawMonth(currentMonth, getSelectedYear());
  canvas.toBlob(blob => {
    const mm = currentMonth.toString().padStart(2,"0");
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `KamiyashiroGoshuin${getSelectedYear()}${mm}.png`;
    a.click();
  }, "image/png");
};
// 一括ZIP保存（修正版）
downloadAllBtn.onclick = async () => {
  try {
    downloadAllBtn.disabled = true;
    downloadAllBtn.textContent = "生成中...";
    const zip = new JSZip();
    const year = getSelectedYear();
    const tempCanvas = document.createElement("canvas");
    const tempCtx = tempCanvas.getContext("2d");
    for (let m = 1; m <= totalMonths; m++) {
      await drawMonth(m, year, tempCtx);
      const blob = await new Promise(r => tempCanvas.toBlob(r, "image/png"));
      zip.file(`KamiyashiroGoshuin${year}${m.toString().padStart(2,"0")}.png`, blob);
    }
    const zipBlob = await zip.generateAsync({ type: "blob" });
    saveAs(zipBlob, `KamiyashiroGoshuin${year}.zip`);
  } catch (error) {
    console.error("ZIP生成エラー:", error);
  } finally {
    downloadAllBtn.disabled = false;
    downloadAllBtn.textContent = "一括ZIP保存";
  }
};
// 初期表示
drawMonth(currentMonth, getSelectedYear());
</script>
</body>
</html>
